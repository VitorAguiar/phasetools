#!/usr/bin/env Rscript

suppressPackageStartupMessages(library(argparse))
suppressPackageStartupMessages(library(tidyverse))

parser <- ArgumentParser()

parser$add_argument("-p", "--phaseout", type = "character",
		    help = "PHASE output file with phasing results")

parser$add_argument("-l", "--loci", type = "character",
		    help = "input_loci.tsv file generated by write_phase_files")

parser$add_argument("-c", "--hlacodes", type = "character",
		    help = "hla_allele_codes.txt generated by write_phase_files")

parser$add_argument("-o", "--outdir", type = "character",
		    help = "output directory")

args <- parser$parse_args()
pout <- args$phaseout 
iloci <- args$loci
hcodes <- args$hlacodes
outdir <- args$outdir

phase_out <- readLines(pout)

phase_best <- grep("(BEGIN|END) BESTPAIRS1", phase_out) %>% 
    {(.[[1]] + 1):(.[[2]] - 1)} %>%
    phase_out[.] 
    
best_list <- split(phase_best, grepl("#", phase_best) %>% cumsum)

loci_df <- read_tsv(iloci) %>%
    select(locus, pos)

hla_codes <- read_tsv(hcodes)

phase_df <- 
    tibble(subject = map_chr(best_list, 1),
	   locus = paste(loci_df$locus, collapse = " "),
	   h1 = trimws(map_chr(best_list, 2)),
	   h2 = trimws(map_chr(best_list, 3))) %>%
    mutate(subject = sub("0 #", "", subject)) %>%
    separate_rows(locus, h1, h2, sep = " ") %>%
    mutate(high_conf = as.integer(!grepl("\\(", h1))) %>%
    mutate_at(vars(h1, h2), . %>% gsub("\\(|\\)", "", .)) %>%
    gather(hap, allele, h1:h2) %>%
    mutate(hap = gsub("h", "", hap),
	   allele = as.integer(allele)) %>%
    filter(grepl("HLA", locus)) %>%
    left_join(loci_df, by = "locus") %>%
    arrange(subject, pos, hap) %>%
    left_join(hla_codes, by = c("subject", "locus", "allele" = "code")) %>%
    select(subject, locus, hap, allele = allele.y, high_conf) %>%
    distinct() 

phase_haps <- phase_df %>%
    select(-high_conf) %>%
    spread(locus, allele)

phase_probs <- phase_df %>%
    distinct(subject, locus, high_conf) %>%
    spread(locus, high_conf)

write_tsv(phase_haps, file.path(outdir, "phase_haps.tsv"))
write_tsv(phase_probs, file.path(outdir, "phase_haps_conf.tsv"))
